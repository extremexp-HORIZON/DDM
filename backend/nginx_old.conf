worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    sendfile on;
    keepalive_timeout 65;

    upstream proxy-service {
          server proxy-service:5522;
     }

    server {
        listen 80;
        server_name localhost;  

        # ✅ Global CORS support for any route
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PATCH, PUT, DELETE' always;
        add_header Access-Control-Allow-Headers 'Authorization, Content-Type' always;

        # ✅ Handle OPTIONS preflight separately
        if ($request_method = OPTIONS ) {
            return 204;
        }

        ##############      CATALOG ENDPOINTS       ###############

        # ✅ File Catalog 
        location /ddm/catalog/ {
            set $original_url http://backend:5001$request_uri;

            proxy_pass http://proxy-service/proxy?to=$original_url;

            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        # ✅My  File Catalog 
        location /ddm/my-catalog/ {
            set $original_url http://backend:5001$request_uri;

            proxy_pass http://proxy-service/proxy?to=$original_url;

            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        # ✅ Advanced File Catalog 
        location /ddm/catalog/advanced {
            set $original_url http://backend:5001$request_uri;

            proxy_pass http://proxy-service/proxy?to=$original_url;

            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        ##############      FILE ENDPOINTS       ###############

        # ✅ File Upload 
        location /ddm/file/upload {
            proxy_pass http://backend:5001/file/upload;
            client_max_body_size 500M;  # Allow large file uploads
            proxy_set_header Host $host;
        }
        # ✅ File Upload Link
        location /ddm/file/upload-link {
            proxy_pass http://backend:5001/file/upload-link;
            proxy_set_header Host $host;
        }
        # ✅ Chunk Upload 
        location /ddm/file/upload/async {
            proxy_pass http://backend:5001/file/upload/async;
            proxy_set_header Host $host;
        }
        # ✅ File Download 
        location ~ ^/ddm/file/([^/]+)$ {
            proxy_pass http://backend:5001/file/$1;
            proxy_set_header Host $host;
        }
         # ✅ File Update 
        location ~ ^/ddm/file/update/([^/]+)$ {
            proxy_pass http://backend:5001/file/update/$1;
            proxy_set_header Host $host;
        }
        # ✅ File Delete
        location ~ ^/ddm/file/([^/]+)/delete$ {
            proxy_pass http://backend:5001/file/$1/delete;
            proxy_set_header Host $host;
        }

        ##############      FILES ENDPOINTS       ###############
        
        # ✅ Multiple File Uploads 
        location /ddm/files/ {
            proxy_pass http://backend:5001/files/;
            client_max_body_size 500M;
            proxy_set_header Host $host;
        }
        # ✅ Multiple File Link Uploads 
        location /ddm/files/upload-link {
            proxy_pass http://backend:5001/files/upload-link;
            proxy_set_header Host $host;
        }
        # ✅ Multiple File Updates 
        location /ddm/files/update {
            proxy_pass http://backend:5001/files/update;
            proxy_set_header Host $host;
        }
        # ✅ Multiple File Deletes 
        location /ddm/files/delete {
            proxy_pass http://backend:5001/files/delete;
            proxy_set_header Host $host;
        }
        # ✅ Multiple File Downloads 
        location /ddm/files/download {
            proxy_pass http://backend:5001/files/download;
            proxy_set_header Host $host;
        }
        ##############      FILE METADATA ENDPOINTS       ###############

        # ✅ File Metadata Operations (POST endpoints and base path)
        location /ddm/file_metadata/ {
            proxy_pass http://backend:5001/file_metadata/;
            proxy_set_header Host $host;
        }

        # ✅ File Metadata by ID (already present for GET)
        location ~ ^/ddm/file_metadata/([^/]+)$ {
            proxy_pass http://backend:5001/file_metadata/$1;
            proxy_set_header Host $host;
        }

        # ✅ Route all /expectations/* to the Flask API
        location /ddm/expectations/ {
            proxy_pass http://backend:5001/expectations/;
            proxy_set_header Host $host;
        }

        location /ddm/expectations/upload-sample {
            proxy_pass http://backend:5001/expectations/upload-sample;
            client_max_body_size 10M;
        }

        # ✅ Parametric Info API Endpoints
        location /ddm/parametrics/ {
            proxy_pass http://backend:5001/parametrics/;
            proxy_set_header Host $host;
        }



        # ✅ Serve Swagger UI
        location /ddm/swagger/ {
            root /app/static/;
            index index.html;
        }

        # ✅ Serve Static Files
        location /ddm/static/ {
            root /app/;
            expires 30d;
            add_header Cache-Control "public, max-age=2592000";
        }

        # ✅ Health Check
        location /ddm/health {
            access_log off;
            return 200 "OK\n";
        }


    }
}
